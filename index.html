<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TPM Bitis System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f2f4f8; margin: 0; padding: 10px; color: #333; }
        .card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .hidden { display: none !important; }
        .input-label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 14px; color: #495057; }
        input, select, textarea, button { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box; }
        button { background: #0056b3; color: white; border: none; font-weight: 600; cursor: pointer; transition: opacity 0.2s; }
        button:disabled { opacity: 0.7; cursor: not-allowed; }
        button.secondary { background: #6c757d; }
        button.logout { background: transparent; color: #dc3545; border: 1px solid #dc3545; margin-top: 10px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .role-badge { background: #e3f2fd; color: #0d47a1; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .alert-box { background: #ffebee; border: 2px solid #d32f2f; padding: 15px; border-radius: 8px; margin-bottom: 15px; color: #c62828; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(211, 47, 47, 0); } 100% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0); } }

        .ticket-item { border-left: 5px solid #ccc; padding: 12px; background: #fff; margin-bottom: 10px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: relative; }
        .ticket-item.open { border-left-color: #dc3545; } .ticket-item.assigned { border-left-color: #ffc107; } .ticket-item.fixed { border-left-color: #17a2b8; } .ticket-item.done { border-left-color: #28a745; }
        .status-tag { position: absolute; top: 12px; right: 12px; font-size: 11px; padding: 2px 6px; border-radius: 4px; color: white; font-weight: bold; }
        .tag-open { background: #dc3545; } .tag-assigned { background: #ffc107; color: #333; } .tag-fixed { background: #17a2b8; } .tag-done { background: #28a745; }

        .detail-row { display: flex; border-bottom: 1px solid #eee; padding: 8px 0; }
        .detail-label { flex: 1; font-weight: bold; color: #555; font-size: 14px; }
        .detail-val { flex: 2; font-size: 14px; text-align: right; }
        .tabs { display: flex; margin-bottom: 15px; background: #e9ecef; border-radius: 8px; padding: 4px; }
        .tab { flex: 1; text-align: center; padding: 10px; border-radius: 6px; font-weight: 600; cursor: pointer; color: #666; font-size: 13px; }
        .tab.active { background: white; color: #0056b3; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .filter-group { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }
        .filter-group > * { flex: 1; min-width: 120px; }
        .kpi-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .kpi-box { background: #fff; padding: 10px; text-align: center; border-radius: 8px; border: 1px solid #eee; }
        .kpi-num { font-size: 18px; font-weight: bold; color: #0056b3; display: block; }
        .kpi-label { font-size: 11px; color: #666; }
        .chart-container { background: white; padding: 10px; border-radius: 8px; margin-bottom: 15px; height: 250px; }

        /* Toast Notification */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { background: #333; color: white; padding: 12px 20px; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-size: 14px; animation: slideIn 0.3s ease-out forwards; max-width: 300px; display: flex; align-items: center; justify-content: space-between; pointer-events: auto; }
        .toast.success { background: #28a745; border-left: 4px solid #155724; }
        .toast.error { background: #dc3545; border-left: 4px solid #721c24; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { to { opacity: 0; transform: translateY(-20px); } }
    </style>
</head>
<body>

    <div id="screen-login" class="card" style="max-width: 400px; margin: 40px auto;">
        <h2 style="text-align:center; color:#0056b3">TPM ƒêƒÉng Nh·∫≠p</h2>
        <label for="log-user" class="input-label">T√™n ƒëƒÉng nh·∫≠p</label>
        <input type="text" id="log-user" placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p...">
        <label for="log-pass" class="input-label">M·∫≠t kh·∫©u</label>
        <input type="password" id="log-pass" placeholder="Nh·∫≠p m·∫≠t kh·∫©u...">
        <button onclick="handleLogin()">ƒêƒÉng Nh·∫≠p</button>
        <button class="secondary" onclick="showDashboard(false)">Xem Dashboard (Kh√°ch)</button>
        <p id="log-msg" style="color:red; text-align:center" role="alert"></p>
    </div>

    <div id="screen-leader" class="hidden">
        <div class="header"><div>Hi, <b class="u-name"></b></div> <div class="role-badge">T·ªî TR∆Ø·ªûNG</div></div>
        <div class="tabs">
            <div class="tab active" onclick="switchLeaderTab(1)">1. B√°o H∆∞</div>
            <div class="tab" onclick="switchLeaderTab(2)">2. G√°n Th·ª£</div>
            <div class="tab" onclick="switchLeaderTab(3)">3. Nghi·ªám Thu</div>
            <div class="tab" onclick="switchLeaderTab(4)">4. L·ªãch S·ª≠</div>
        </div>
        <div id="l-tab-1" class="card">
            <select id="l-chuyen">
                <option value="">-- Ch·ªçn Chuy·ªÅn --</option>
                <option value="Ho√†n ch·ªânh 1">Ho√†n ch·ªânh 1</option><option value="Ho√†n ch·ªânh 2">Ho√†n ch·ªânh 2</option>
                <option value="May 1">May 1</option><option value="May 2">May 2</option><option value="May 3">May 3</option><option value="May 4">May 4</option><option value="May 5">May 5</option><option value="May 6">May 6</option>
                <option value="D·∫≠p 1">D·∫≠p 1</option><option value="D·∫≠p 2">D·∫≠p 2</option>
                <option value="In l·ª•a">In l·ª•a</option><option value="B·∫ø h√¨nh">B·∫ø h√¨nh</option>
                <option value="C√°n d√°n">C√°n d√°n</option><option value="C·∫Øt tr·ª•c">C·∫Øt tr·ª•c</option><option value="√âp d·∫•u ch√¢n">√âp d·∫•u ch√¢n</option>
                <option value="Chu·∫©n b·ªã ƒë·∫ø">Chu·∫©n b·ªã ƒë·∫ø</option><option value="B·ªçc ƒë·∫ø">B·ªçc ƒë·∫ø</option><option value="B√°n th√†nh ph·∫©m">B√°n th√†nh ph·∫©m</option><option value="C·∫Øt nhi·ªát">C·∫Øt nhi·ªát</option><option value="Ph√°t sinh">Ph√°t sinh</option>
            </select>
            <input type="text" id="l-msts" placeholder="M√£ s·ªë t√†i s·∫£n (MSTS)">
            <label style="font-size:12px">Th·ªùi ƒëi·ªÉm h∆∞:</label><input type="datetime-local" id="l-time">
            <button onclick="leaderCreate(this)">G·ª≠i B√°o C√°o</button>
        </div>
        <div id="l-tab-2" class="hidden"><div class="card"><h3>Ch·ªù G√°n B·∫£o Tr√¨</h3><div id="l-list-open"></div><button class="secondary" onclick="loadLeaderOpen()">L√†m m·ªõi</button></div></div>
        <div id="l-tab-3" class="hidden"><div class="card"><h3>C·∫ßn X·ª≠ L√Ω (Nghi·ªám thu/Thay m√°y)</h3><div id="l-list-actionable"></div><button class="secondary" onclick="loadLeaderActionable()">L√†m m·ªõi</button></div></div>
        <div id="l-tab-4" class="hidden"><div class="card"><h3>L·ªãch S·ª≠ (50 g·∫ßn nh·∫•t)</h3><div id="l-history-list"></div><button class="secondary" onclick="loadHistory('l-history-list')">L√†m m·ªõi</button></div></div>
        <button style="background:#17a2b8" onclick="showDashboard(true)">Xem Dashboard Chi Ti·∫øt</button>
        <button class="logout" onclick="doLogout()">ƒêƒÉng Xu·∫•t</button>
    </div>

    <div id="screen-tech" class="hidden">
        <div class="header"><div>Hi, <b class="u-name"></b></div> <div class="role-badge">B·∫¢O TR√å</div></div>
        <div id="tech-alert-area" class="hidden"><div class="alert-box"><strong>üîî C√ì M√ÅY H∆Ø M·ªöI!</strong><div id="tech-alert-list"></div></div></div>
        <div class="card"><h3>Vi·ªác C·ªßa T√¥i (<span id="count-myjob">0</span>)</h3><div id="t-list"></div><button class="secondary" onclick="loadTechJobs()">L√†m m·ªõi</button></div>
        <div class="card"><h3>Ti·ªán √çch</h3><button class="secondary" onclick="openHistoryModal()">L·ªãch S·ª≠ ƒê√£ L√†m</button><button style="background:#17a2b8; margin-top:5px" onclick="showDashboard(true)">Xem Dashboard</button></div>
        <button class="logout" onclick="doLogout()">ƒêƒÉng Xu·∫•t</button>
    </div>

    <div id="modal-detail" class="card hidden" style="position:fixed; top:5%; left:5%; right:5%; z-index:200; max-height:90%; overflow-y:auto; border:2px solid #0056b3; box-shadow:0 10px 25px rgba(0,0,0,0.5);"><div class="header" style="border-bottom:1px solid #eee; padding-bottom:10px;"><h3 style="margin:0; color:#0056b3">Chi Ti·∫øt Phi·∫øu</h3><button class="secondary" style="width:auto; padding:5px 10px" onclick="document.getElementById('modal-detail').classList.add('hidden')">X</button></div><div id="detail-content"></div><button onclick="document.getElementById('modal-detail').classList.add('hidden')" style="margin-top:15px;">ƒê√≥ng</button></div>
    <div id="modal-history" class="card hidden" style="position:fixed; top:20px; left:10px; right:10px; bottom:20px; z-index:100; overflow-y:auto;"><div class="header"><h3>L·ªãch S·ª≠</h3><button class="secondary" style="width:auto; padding:5px 10px" onclick="document.getElementById('modal-history').classList.add('hidden')">ƒê√≥ng</button></div><div id="common-history-list">ƒêang t·∫£i...</div></div>

    <div id="modal-assign" class="card hidden" style="position:fixed; top:20px; left:20px; right:20px; z-index:99; border:2px solid #0056b3"><h3>X√°c nh·∫≠n B·∫£o Tr√¨ ƒê·∫øn</h3><input type="hidden" id="a-id"><input type="hidden" id="a-row"><p>M√°y: <b id="a-msts"></b></p><label>Nh√¢n Vi√™n:</label><select id="a-tech"><option value="">-- Ch·ªçn T√™n --</option><option value="Ho√†ng ƒê·ª©c Thu·∫ßn">Ho√†ng ƒê·ª©c Thu·∫ßn</option><option value="B√πi Thanh Ho√†ng">B√πi Thanh Ho√†ng</option><option value="Nguy·ªÖn Tu·∫•n Khanh">Nguy·ªÖn Tu·∫•n Khanh</option><option value="Nguy·ªÖn VƒÉn Khanh">Nguy·ªÖn VƒÉn Khanh</option><option value="Nguy·ªÖn Nh·∫•t ƒê·∫≥ng">Nguy·ªÖn Nh·∫•t ƒê·∫≥ng</option><option value="Phan VƒÉn H·ªì">Phan VƒÉn H·ªì</option><option value="Ph·∫°m ƒê·∫Øc Th·ª•y">Ph·∫°m ƒê·∫Øc Th·ª•y</option></select><label>Th·ªùi gian ƒë·∫øn:</label><input type="datetime-local" id="a-time"><button onclick="leaderAssignSubmit(this)">X√°c Nh·∫≠n</button><button class="secondary" onclick="document.getElementById('modal-assign').classList.add('hidden')">H·ªßy</button></div>

    <div id="modal-finish" class="card hidden" style="position:fixed; top:20px; left:20px; right:20px; z-index:99; border:2px solid #28a745"><h3>B√°o C√°o S·ª≠a Xong</h3><input type="hidden" id="f-id"><input type="hidden" id="f-row"><p>M√°y: <b id="f-msts"></b></p><label>Nh√≥m l·ªói (Nh·∫≠p tay):</label><input type="text" id="f-nhomloi" placeholder="VD: C∆° kh√≠..."><label>Bi·ªán ph√°p:</label><textarea id="f-bienphap" rows="2"></textarea><label>Gi·ªù s·ª≠a xong:</label><input type="datetime-local" id="f-time"><button style="background:#28a745" onclick="techFinishSubmit(this)">G·ª≠i B√°o C√°o</button><button class="secondary" onclick="document.getElementById('modal-finish').classList.add('hidden')">H·ªßy</button></div>

    <div id="modal-action" class="card hidden" style="position:fixed; top:20px; left:20px; right:20px; z-index:99; border:2px solid #17a2b8"><h3>X·ª≠ L√Ω Nghi·ªám Thu</h3><input type="hidden" id="c-id"><input type="hidden" id="c-row"><input type="hidden" id="c-type"><p>M√°y: <b id="c-msts"></b></p><p id="c-status-text"></p><div id="swap-form" class="hidden"><div style="background:#fff3cd; padding:10px; border-radius:6px; margin-bottom:10px;"><label>M√£ M√°y Thay Th·∫ø:</label><input type="text" id="c-new-msts"><label>Gi·ªù Chuy·ªÅn Ch·∫°y L·∫°i:</label><input type="datetime-local" id="c-time-swap"><button style="background:#ffc107; color:black" onclick="leaderSwapSubmit(this)">X√°c Nh·∫≠n Thay M√°y</button></div></div><div id="confirm-form" class="hidden"><label>Gi·ªù Chuy·ªÅn Ch·∫°y L·∫°i:</label><input type="datetime-local" id="c-time-confirm"><p style="font-size:11px;color:#666"><i>(M·∫∑c ƒë·ªãnh l·∫•y gi·ªù s·ª≠a xong)</i></p><button style="background:#28a745" onclick="leaderConfirmSubmit(this)">Nghi·ªám Thu (Done)</button></div><button class="secondary" onclick="document.getElementById('modal-action').classList.add('hidden')">H·ªßy</button></div>

    <div id="screen-dashboard" class="hidden"><div class="header"><h3>Dashboard TPM</h3><button class="secondary" style="width:auto; padding:5px 15px;" onclick="goBack()">Quay L·∫°i</button></div><div class="card"><div class="filter-group"><select id="d-vsm"><option value="all">T·∫•t c·∫£ VSM</option><option value="VSM 1">VSM 1</option><option value="VSM 2">VSM 2</option></select><select id="d-line"><option value="all">T·∫•t c·∫£ Chuy·ªÅn</option><option value="Ho√†n ch·ªânh 1">Ho√†n ch·ªânh 1</option><option value="Ho√†n ch·ªânh 2">Ho√†n ch·ªânh 2</option><option value="May 1">May 1</option><option value="May 2">May 2</option><option value="May 3">May 3</option><option value="May 4">May 4</option><option value="May 5">May 5</option><option value="May 6">May 6</option><option value="D·∫≠p 1">D·∫≠p 1</option><option value="D·∫≠p 2">D·∫≠p 2</option><option value="In l·ª•a">In l·ª•a</option><option value="B·∫ø h√¨nh">B·∫ø h√¨nh</option><option value="C√°n d√°n">C√°n d√°n</option><option value="C·∫Øt tr·ª•c">C·∫Øt tr·ª•c</option><option value="√âp d·∫•u ch√¢n">√âp d·∫•u ch√¢n</option><option value="Chu·∫©n b·ªã ƒë·∫ø">Chu·∫©n b·ªã ƒë·∫ø</option><option value="B·ªçc ƒë·∫ø">B·ªçc ƒë·∫ø</option><option value="B√°n th√†nh ph·∫©m">B√°n th√†nh ph·∫©m</option><option value="C·∫Øt nhi·ªát">C·∫Øt nhi·ªát</option><option value="Ph√°t sinh">Ph√°t sinh</option></select></div><div class="filter-group"><input type="date" id="d-start" title="T·ª´ ng√†y"><input type="date" id="d-end" title="ƒê·∫øn ng√†y"></div><div class="filter-group"><button onclick="loadDashboardData()">L·ªçc D·ªØ Li·ªáu</button><button class="secondary" onclick="resetFilters()">Reset (Xem T·∫•t C·∫£)</button></div></div><div class="kpi-grid"><div class="kpi-box"><span class="kpi-num" id="kpi-total">0</span><span class="kpi-label">T·ªïng Phi·∫øu</span></div><div class="kpi-box"><span class="kpi-num" id="kpi-dt">0</span><span class="kpi-label">Downtime (h)</span></div><div class="kpi-box"><span class="kpi-num" id="kpi-mttr">0</span><span class="kpi-label">MTTR (ph√∫t)</span></div></div><div class="chart-container"><canvas id="c-line-ticket"></canvas></div><div class="chart-container"><canvas id="c-line-dt"></canvas></div><div class="chart-container"><canvas id="c-tech-ticket"></canvas></div><div class="chart-container"><canvas id="c-tech-mttr"></canvas></div></div>

    <script>
        // ==============================================
        const API_URL = 'https://script.google.com/macros/s/AKfycbxcAcOlhUuqTF1dIwOMZdT5cTEFkohbD_b45cj12rNRD2jX8TJIvNHXSBlsgstQv7Eq/exec'; // D√ÅN URL V√ÄO ƒê√ÇY
        // ==============================================

        let currentUser = null, refreshInterval = null, lastAlertCount = 0, lastMyJobCount = 0;
        const ticketCache = {};
        function cacheTicket(t) { ticketCache[t.id] = t; return t.id; }
        const beepSound = new Audio("data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU");
        const vsmMap = {"Ho√†n ch·ªânh 1": "VSM 1", "Ho√†n ch·ªânh 2": "VSM 2", "May 1": "VSM 1", "May 2": "VSM 1", "May 3": "VSM 1", "May 4": "VSM 1", "May 5": "VSM 2", "May 6": "VSM 2", "D·∫≠p 1": "VSM 1", "D·∫≠p 2": "VSM 2", "In l·ª•a": "VSM 1", "B·∫ø h√¨nh": "VSM 1", "C√°n d√°n": "VSM 1", "C·∫Øt tr·ª•c": "VSM 1", "√âp d·∫•u ch√¢n": "VSM 2", "Chu·∫©n b·ªã ƒë·∫ø": "VSM 2", "B·ªçc ƒë·∫ø": "VSM 2", "B√°n th√†nh ph·∫©m": "VSM 2", "C·∫Øt nhi·ªát": "VSM 1", "Ph√°t sinh": "Ph√°t sinh"};

        document.addEventListener('DOMContentLoaded', () => { checkAutoLogin(); });

        function showToast(msg, type='info') {
            let c = document.getElementById('toast-container');
            if (!c) { c = document.createElement('div'); c.id='toast-container'; c.className='toast-container'; document.body.appendChild(c); }
            const t = document.createElement('div'); t.className = `toast ${type}`; t.innerText = msg;
            c.appendChild(t);
            setTimeout(() => { t.style.animation = 'fadeOut 0.5s forwards'; setTimeout(() => t.remove(), 500); }, 3000);
        }

        function post(data, cb, btn=null) {
            if(API_URL.includes('YOUR_')) { showToast("Ch∆∞a d√°n API URL!", "error"); return; }
            let orgTxt = '';
            if(btn) { orgTxt = btn.innerText; btn.innerText = "ƒêang x·ª≠ l√Ω..."; btn.disabled = true; }
            fetch(API_URL, {method:'POST', body:JSON.stringify(data)})
                .then(r=>r.json())
                .then(res => { if(btn){btn.innerText=orgTxt; btn.disabled=false;} cb(res); })
                .catch(e=>{ console.log(e); if(btn){btn.innerText=orgTxt; btn.disabled=false;} });
        }

        function setNow(id) { const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); document.getElementById(id).value = now.toISOString().slice(0,16); }
        function notifyUser() { try { beepSound.play().catch(e=>{}); if(navigator.vibrate) navigator.vibrate([500, 300, 500]); } catch(e){} }
        function showScreen(id) { document.querySelectorAll('body > div[id^="screen-"]').forEach(d => d.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
        function goBack() { if (!currentUser) showScreen('screen-login'); else if (currentUser.role === 'leader') showScreen('screen-leader'); else showScreen('screen-tech'); }
        function checkAutoLogin() { const s = localStorage.getItem('tpm_user'); if (s) { currentUser = JSON.parse(s); restoreSession(); } }
        function restoreSession() {
            document.querySelectorAll('.u-name').forEach(el => el.innerText = currentUser.fullname);
            document.getElementById('screen-login').classList.add('hidden');
            if (currentUser.role === 'leader') { showScreen('screen-leader'); setNow('l-time'); loadLeaderOpen(); }
            else { showScreen('screen-tech'); loadTechJobs(); startAutoRefresh(); }
        }
        function handleLogin() {
            if(API_URL.includes('YOUR_')) { showToast("Ch∆∞a d√°n API URL!", "error"); return; }
            const u = document.getElementById('log-user').value, p = document.getElementById('log-pass').value;
            const btn = document.querySelector('#screen-login button');
            btn.innerText = "ƒêang x·ª≠ l√Ω...";
            btn.disabled = true;
            post({action:'login', username:u, password:p}, res => {
                btn.innerText = "ƒêƒÉng Nh·∫≠p";
                btn.disabled = false;
                currentUser = res; localStorage.setItem('tpm_user', JSON.stringify(currentUser)); restoreSession();
            });
        }
        function doLogout() { if(refreshInterval) clearInterval(refreshInterval); localStorage.removeItem('tpm_user'); location.reload(); }

        // LEADER
        function switchLeaderTab(n) {
            for(let i=1; i<=4; i++) document.getElementById('l-tab-'+i).classList.add('hidden');
            document.getElementById('l-tab-'+n).classList.remove('hidden');
            document.querySelectorAll('.tab').forEach((t,i) => t.classList.toggle('active', i===n-1));
            if(n===1) setNow('l-time'); if(n===2) loadLeaderOpen(); if(n===3) loadLeaderActionable(); if(n===4) loadHistory('l-history-list');
        }
        function leaderCreate(btn) {
            const d = { chuyen:document.getElementById('l-chuyen').value, ma_so:document.getElementById('l-msts').value, gio_hu:document.getElementById('l-time').value, nguoi_tao:currentUser.fullname };
            if(!d.ma_so) return showToast("Thi·∫øu th√¥ng tin", "error");
            post({action:'leader_create', data:d}, res => {
                showToast(res.message, "success"); document.getElementById('l-msts').value='';
                switchLeaderTab(2); // T·ª∞ ƒê·ªòNG CHUY·ªÇN TAB 2
            }, btn);
        }
        function loadLeaderOpen() {
            const div = document.getElementById('l-list-open'); div.innerHTML = 'ƒêang t·∫£i...';
            post({action:'leader_get_open'}, res => {
                if(res.data.length === 0) {
                    div.innerHTML = 'Kh√¥ng c√≥ phi·∫øu ch·ªù.';
                } else {
                    let html = '';
                    res.data.forEach(i => html += `<div class="ticket-item open"><h4>${i.chuyen} - ${i.ma_so}</h4><p>H∆∞ l√∫c: ${new Date(i.gio_hu).toLocaleString()}</p><button onclick='openAssign("${cacheTicket(i)}")'>B·∫£o Tr√¨ ƒê·∫øn</button></div>`);
                    div.innerHTML = html;
                }
            });
        }
        function openAssign(id) { const i=ticketCache[id]; document.getElementById('a-id').value=i.id; document.getElementById('a-row').value=i.rowIndex; document.getElementById('a-msts').innerText=i.ma_so; setNow('a-time'); document.getElementById('modal-assign').classList.remove('hidden'); }
        function leaderAssignSubmit(btn) {
            const t = document.getElementById('a-tech').value, time = document.getElementById('a-time').value;
            if(!t || !time) return showToast("Vui l√≤ng ch·ªçn B·∫£o tr√¨ v√† Gi·ªù ƒë·∫øn!", "error");
            post({action:'leader_assign', id:document.getElementById('a-id').value, rowIndex:document.getElementById('a-row').value, data:{ten_bao_tri:t, gio_den:time}}, res => {
                showToast(res.message, "success"); document.getElementById('modal-assign').classList.add('hidden'); loadLeaderOpen();
            }, btn);
        }
        // NEW: NGHI·ªÜM THU / THAY M√ÅY
        function loadLeaderActionable() {
            const div = document.getElementById('l-list-actionable'); div.innerHTML = 'ƒêang t·∫£i...';
            post({action:'leader_get_actionable'}, res => {
                if(res.data.length === 0) {
                    div.innerHTML = 'Kh√¥ng c√≥ phi·∫øu c·∫ßn x·ª≠ l√Ω.';
                } else {
                    let html = '';
                    res.data.forEach(i => {
                        if(i.type === 'fixed') {
                            html += `<div class="ticket-item fixed"><h4>${i.chuyen} - ${i.ma_so}</h4><p>ƒê√£ s·ª≠a xong: ${new Date(i.gio_xong).toLocaleString()}</p><button style="background:#28a745" onclick='openActionModal("${cacheTicket(i)}")'>Nghi·ªám Thu</button></div>`;
                        } else {
                            html += `<div class="ticket-item assigned"><h4>${i.chuyen} - ${i.ma_so}</h4><p>ƒêang s·ª≠a b·ªüi: ${i.ten_bao_tri}</p><button style="background:#ffc107; color:black" onclick='openActionModal("${cacheTicket(i)}")'>Thay M√°y Kh√°c</button></div>`;
                        }
                    });
                    div.innerHTML = html;
                }
            });
        }
        function openActionModal(id) {
            const i=ticketCache[id];
            document.getElementById('c-id').value = i.id; document.getElementById('c-row').value = i.rowIndex;
            document.getElementById('c-type').value = i.type;
            document.getElementById('c-msts').innerText = i.ma_so;
            const statusTxt = i.type==='fixed' ? `B·∫£o tr√¨ xong: ${new Date(i.gio_xong).toLocaleTimeString()}` : `ƒêang s·ª≠a b·ªüi: ${i.ten_bao_tri}`;
            document.getElementById('c-status-text').innerText = statusTxt;

            if(i.type === 'swap') {
                document.getElementById('swap-form').classList.remove('hidden');
                document.getElementById('confirm-form').classList.add('hidden');
                setNow('c-time-swap');
            } else {
                document.getElementById('swap-form').classList.add('hidden');
                document.getElementById('confirm-form').classList.remove('hidden');
                const td = new Date(i.gio_xong); td.setMinutes(td.getMinutes() - td.getTimezoneOffset());
                document.getElementById('c-time-confirm').value = td.toISOString().slice(0,16);
            }
            document.getElementById('modal-action').classList.remove('hidden');
        }
        function leaderSwapSubmit(btn) {
            const newM = document.getElementById('c-new-msts').value, time = document.getElementById('c-time-swap').value;
            if(!newM) return showToast("Nh·∫≠p MSTS m√°y m·ªõi!", "error");
            post({action:'leader_update_swap', id:document.getElementById('c-id').value, rowIndex:document.getElementById('c-row').value, data:{gio_chay_lai:time, ma_so_thay_the:newM}}, res => {
                showToast(res.message, "success"); document.getElementById('modal-action').classList.add('hidden'); loadLeaderActionable();
            }, btn);
        }
        function leaderConfirmSubmit(btn) {
            const time = document.getElementById('c-time-confirm').value;
            post({action:'leader_confirm_done', id:document.getElementById('c-id').value, rowIndex:document.getElementById('c-row').value, data:{gio_chay_lai: time}}, res => {
                showToast(res.message, "success"); document.getElementById('modal-action').classList.add('hidden'); loadLeaderActionable();
            }, btn);
        }

        // TECH
        let lastTechDataStr = '';
        function startAutoRefresh() { refreshInterval = setInterval(() => { if(!document.getElementById('screen-tech').classList.contains('hidden')) loadTechJobs(true); }, 15000); }
        function loadTechJobs(silent) {
            const divMy = document.getElementById('t-list'); if(!silent) divMy.innerHTML = 'ƒêang t·∫£i...';
            post({action:'tech_get_jobs', fullname: currentUser.fullname}, res => {
                const currentDataStr = JSON.stringify(res.data);
                if (silent && currentDataStr === lastTechDataStr) return;
                lastTechDataStr = currentDataStr;

                const divAlert = document.getElementById('tech-alert-list');
                const curAlert = res.data.alertJobs.length;
                if(curAlert > 0) {
                    document.getElementById('tech-alert-area').classList.remove('hidden');
                    let alertHtml = '';
                    res.data.alertJobs.forEach(i => alertHtml += `<div style="border-bottom:1px dashed #ccc; padding:5px;"><b>${i.chuyen}</b>: ${i.ma_so}</div>`);
                    divAlert.innerHTML = alertHtml;
                    if(silent && curAlert > lastAlertCount) notifyUser();
                } else {
                    divAlert.innerHTML = '';
                    document.getElementById('tech-alert-area').classList.add('hidden');
                }
                lastAlertCount = curAlert;

                document.getElementById('count-myjob').innerText = res.data.myJobs.length;
                if(res.data.myJobs.length === 0 && !silent) {
                    divMy.innerHTML = 'Ch∆∞a c√≥ vi·ªác.';
                } else if (res.data.myJobs.length > 0) {
                    let myJobsHtml = '';
                    res.data.myJobs.forEach(i => {
                        let statusText = "Ch·ªù s·ª≠a"; if(i.is_swapped) statusText = "<b style='color:red'>ƒê√£ thay m√°y - S·ª≠a m√°y c≈© n√†y!</b>";
                        myJobsHtml += `<div class="ticket-item assigned"><h4>${i.chuyen} - ${i.ma_so}</h4><p>${statusText}</p><button style="background:#28a745" onclick='openFinish("${cacheTicket(i)}")'>S·ª≠a Xong</button></div>`;
                    });
                    divMy.innerHTML = myJobsHtml;
                } else {
                    divMy.innerHTML = '';
                }
            });
        }
        function openFinish(id) { const i=ticketCache[id]; document.getElementById('f-id').value=i.id; document.getElementById('f-row').value=i.rowIndex; document.getElementById('f-msts').innerText=i.ma_so; setNow('f-time'); document.getElementById('modal-finish').classList.remove('hidden'); }
        function techFinishSubmit(btn) {
            const d = { nhom_loi:document.getElementById('f-nhomloi').value, bien_phap:document.getElementById('f-bienphap').value, gio_xong:document.getElementById('f-time').value };
            if(!d.gio_xong) return showToast("Nh·∫≠p gi·ªù xong", "error");
            post({action:'tech_finish', id:document.getElementById('f-id').value, rowIndex:document.getElementById('f-row').value, data:d}, res => { showToast(res.message, "success"); document.getElementById('modal-finish').classList.add('hidden'); loadTechJobs(); }, btn);
        }

        // HISTORY & DASHBOARD
        function openHistoryModal() { document.getElementById('modal-history').classList.remove('hidden'); loadHistory('common-history-list'); }
        function loadHistory(targetId) {
            const div = document.getElementById(targetId); div.innerHTML = 'ƒêang t·∫£i...';
            post({action:'get_history', role: currentUser.role, fullname: currentUser.fullname}, res => {
                if(res.data.length === 0) {
                    div.innerHTML = 'Tr·ªëng.';
                } else {
                    let html = '';
                    res.data.forEach(i => {
                        const tag = i.status==='Done'?'done':(i.status==='Fixed'?'fixed':(i.status==='Assigned'?'assigned':'open'));
                        html += `<div class="ticket-item ${tag}"><span class="status-tag tag-${tag}">${i.status}</span><h4>${i.chuyen} - ${i.ma_so}</h4><p style="margin-bottom:5px; font-size:12px">H∆∞: ${formatDate(i.gio_hu)}</p><button style="padding:5px 10px; font-size:12px" onclick='viewDetail("${cacheTicket(i)}")'>Chi Ti·∫øt</button></div>`;
                    });
                    div.innerHTML = html;
                }
            });
        }
        function viewDetail(id) {
            const i=ticketCache[id];
            const fmt = (d) => d ? new Date(d).toLocaleString() : '---';
            const swapInfo = i.ma_so_thay_the ? `<div style="color:red; font-weight:bold; margin-top:5px;">Thay m√°y m·ªõi: ${i.ma_so_thay_the}</div>` : '';
            const html = `<div class="detail-row"><span class="detail-label">Tr·∫°ng th√°i:</span><span class="detail-val" style="color:#0056b3">${i.status}</span></div><div class="detail-row"><span class="detail-label">Ng∆∞·ªùi t·∫°o:</span><span class="detail-val">${i.nguoi_tao||'---'}</span></div><div class="detail-row"><span class="detail-label">MSTS:</span><span class="detail-val">${i.ma_so}</span></div><div class="detail-row"><span class="detail-label">Chuy·ªÅn:</span><span class="detail-val">${i.chuyen}</span></div><div class="detail-row"><span class="detail-label">H∆∞:</span><span class="detail-val">${fmt(i.gio_hu)}</span></div><div class="detail-row"><span class="detail-label">ƒê·∫øn:</span><span class="detail-val">${fmt(i.gio_den)}</span></div><div class="detail-row"><span class="detail-label">Th·ª£:</span><span class="detail-val">${i.ten_bao_tri||'---'}</span></div><div class="detail-row"><span class="detail-label">S·ª≠a Xong:</span><span class="detail-val">${fmt(i.gio_xong)}</span></div><div class="detail-row"><span class="detail-label">Ch·∫°y l·∫°i:</span><span class="detail-val">${fmt(i.gio_chay_lai)}</span></div><div class="detail-row" style="flex-direction:column"><span class="detail-label">L·ªói:</span><div style="background:#f9f9f9; padding:5px;">${i.nhom_loi||'---'}</div></div><div class="detail-row" style="flex-direction:column; border:none"><span class="detail-label">Bi·ªán ph√°p:</span><div style="background:#f9f9f9; padding:5px;">${i.bien_phap||'---'}</div>${swapInfo}</div>`;
            document.getElementById('detail-content').innerHTML = html; document.getElementById('modal-detail').classList.remove('hidden');
        }
        function formatDate(s) { return s ? new Date(s).toLocaleString('vi-VN', {hour:'2-digit', minute:'2-digit', day:'2-digit', month:'2-digit'}) : ''; }

        let charts = {};
        function resetFilters() { document.getElementById('d-vsm').value='all'; document.getElementById('d-line').value='all'; document.getElementById('d-start').value=''; document.getElementById('d-end').value=''; loadDashboardData(); }
        function showDashboard(isLoggedIn) { showScreen('screen-dashboard'); if(!document.getElementById('d-start').value) resetFilters(); else loadDashboardData(); }
        function loadDashboardData() {
            post({action:'get_dashboard'}, res => {
                const raw = res.data, vsmV = document.getElementById('d-vsm').value, lineV = document.getElementById('d-line').value;
                const sIn = document.getElementById('d-start').value, eIn = document.getElementById('d-end').value;
                const filtered = raw.filter(i => {
                    if (sIn && eIn) { const d=i.gio_hu?new Date(i.gio_hu):new Date(), s=new Date(sIn), e=new Date(eIn); e.setHours(23,59,59); if(d<s||d>e) return false; }
                    if(vsmV!=='all' && (vsmMap[i.chuyen]||"Kh√°c")!==vsmV) return false;
                    if(lineV!=='all' && i.chuyen!==lineV) return false;
                    return true;
                });
                let tot=0, mttrS=0, mttrC=0, lS={}, tS={};
                filtered.forEach(i=>{
                    const l=i.chuyen||"Kh√°c", t=i.ten_bao_tri||"Ch∆∞a g√°n";
                    if(!lS[l])lS[l]={tk:0,dt:0}; if(!tS[t])tS[t]={tk:0,dt:0};
                    lS[l].tk++; if(i.ten_bao_tri) tS[t].tk++;
                    // Downtime Chuy·ªÅn: Gi·ªù ch·∫°y l·∫°i (I) - Gi·ªù h∆∞ (F)
                    if(i.gio_hu && i.gio_chay_lai){ const dt=(new Date(i.gio_chay_lai)-new Date(i.gio_hu))/36e5; if(dt>0){ tot+=dt; lS[l].dt+=dt; } }
                    // MTTR M√°y: Gi·ªù s·ª≠a xong (L) - Gi·ªù h∆∞ (F)
                    if(i.gio_hu && i.gio_xong){ const rep=(new Date(i.gio_xong)-new Date(i.gio_hu))/60000; if(rep>0 && i.ten_bao_tri){ tS[t].dt+=rep; mttrS+=rep; mttrC++; } }
                });
                document.getElementById('kpi-total').innerText=filtered.length; document.getElementById('kpi-dt').innerText=tot.toFixed(1); document.getElementById('kpi-mttr').innerText=mttrC?(mttrS/mttrC).toFixed(0):0;
                drawC('c-line-ticket','S·ªë phi·∫øu',lS,'tk','#36a2eb'); drawC('c-line-dt','Downtime Chuy·ªÅn (h)',lS,'dt','#ff6384'); drawC('c-tech-ticket','Phi·∫øu',tS,'tk','#4bc0c0');
                const tL=Object.keys(tS), tM=tL.map(k=>tS[k].tk?((tS[k].dt)/tS[k].tk).toFixed(0):0); drawCS('c-tech-mttr','MTTR B·∫£o Tr√¨ (p)',tL,tM,'#ff9f40');
            });
        }
        function drawC(id,l,o,k,c){drawCS(id,l,Object.keys(o),Object.keys(o).map(x=>o[x][k]),c);}
        function drawCS(id,l,lb,v,c){const x=document.getElementById(id).getContext('2d'); if(charts[id])charts[id].destroy(); charts[id]=new Chart(x,{type:'bar',data:{labels:lb,datasets:[{label:l,data:v,backgroundColor:c}]},options:{responsive:true,maintainAspectRatio:false}});}
    </script>
</body>

</html>
